<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hành Trình Bất Ổn - Mobile Edition</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            flex-direction: column;
            touch-action: none; /* Chặn zoom/scroll trên mobile */
        }
        canvas {
            border: 4px solid #333;
            background-color: #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            max-width: 100%;
            max-height: 80vh; /* Chừa chỗ cho nút bấm */
        }
        #message {
            margin-bottom: 10px;
            font-size: 18px;
            color: #333;
            font-weight: bold;
            height: 25px;
            text-align: center;
        }
        .controls-hint {
            margin-top: 5px;
            color: #666;
            font-size: 12px;
            display: none; /* Ẩn mặc định, hiện bằng JS nếu là PC */
        }

        /* Giao diện nút bấm cảm ứng */
        #touch-controls {
            display: none; /* Ẩn mặc định, hiện bằng JS nếu là Mobile */
            width: 100%;
            height: 120px;
            position: absolute;
            bottom: 0;
            left: 0;
            padding: 10px 20px;
            box-sizing: border-box;
            justify-content: space-between;
            align-items: center;
            pointer-events: none; /* Để touch xuyên qua vùng trống */
        }

        .btn-group {
            pointer-events: auto;
            display: flex;
            gap: 20px;
        }

        .t-btn {
            width: 70px;
            height: 70px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .t-btn:active, .t-btn.active {
            background-color: rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
        }

        #btn-jump {
            background-color: rgba(255, 71, 87, 0.4); /* Màu đỏ nhạt */
        }
    </style>
</head>
<body>

    <div id="message">Loading...</div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <div class="controls-hint" id="pc-hint">PC: WASD hoặc Mũi tên để di chuyển</div>

    <div id="touch-controls">
        <div class="btn-group">
            <div class="t-btn" id="btn-left">◄</div>
            <div class="t-btn" id="btn-right">►</div>
        </div>
        <div class="btn-group">
            <div class="t-btn" id="btn-jump">▲</div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const msgDiv = document.getElementById('message');
    const touchControls = document.getElementById('touch-controls');
    const pcHint = document.getElementById('pc-hint');

    // --- XỬ LÝ PHÁT HIỆN THIẾT BỊ ---
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        touchControls.style.display = 'flex';
        msgDiv.innerText = "Chạm nút để chơi!";
    } else {
        pcHint.style.display = 'block';
        msgDiv.innerText = "Dùng phím WASD hoặc Mũi tên...";
    }

    // --- GAME LOGIC (GIỮ NGUYÊN TÍNH NĂNG TROLL) ---

    // Cấu hình người chơi
    const player = {
        x: 50, y: 200, width: 30, height: 30,
        color: '#ff4757',
        dx: 0, dy: 0, speed: 5,
        jumpPower: -12, gravity: 0.6,
        grounded: false
    };

    const goal = { x: 720, y: 260, width: 40, height: 40, color: '#2ed573' };
    let platforms = [];
    
    // Biến lưu trạng thái input (gộp cả phím và cảm ứng)
    const input = {
        left: false,
        right: false,
        jump: false
    };

    function initMap() {
        player.x = 50; player.y = 200; player.dx = 0; player.dy = 0;
        goal.x = 720;
        
        platforms = [
            { x: 0, y: 350, w: 200, h: 50, type: 0 },
            { x: 250, y: 300, w: 100, h: 20, type: 2 }, // Sàn rơi
            { x: 400, y: 350, w: 150, h: 50, type: 0 },
            { x: 600, y: 300, w: 200, h: 100, type: 0 },
            { x: 220, y: 200, w: 30, h: 30, type: 1 }, // Troll: Chặn nhảy
            { x: 500, y: 240, w: 20, h: 110, type: 1 } // Troll: Tường tàng hình
        ];
        
        if(!isMobile) msgDiv.innerText = "Cố lên! Dễ ợt mà!";
    }

    // --- XỬ LÝ INPUT BÀN PHÍM (PC) ---
    document.addEventListener('keydown', (e) => {
        if (e.code === 'ArrowLeft' || e.code === 'KeyA') input.left = true;
        if (e.code === 'ArrowRight' || e.code === 'KeyD') input.right = true;
        if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') input.jump = true;
    });

    document.addEventListener('keyup', (e) => {
        if (e.code === 'ArrowLeft' || e.code === 'KeyA') input.left = false;
        if (e.code === 'ArrowRight' || e.code === 'KeyD') input.right = false;
        if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') input.jump = false;
    });

    // --- XỬ LÝ INPUT CẢM ỨNG (MOBILE) ---
    function setupTouchButton(id, key) {
        const btn = document.getElementById(id);
        
        // Dùng touchstart/end cho mobile mượt hơn
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); input[key] = true; btn.classList.add('active'); }, {passive: false});
        btn.addEventListener('touchend', (e) => { e.preventDefault(); input[key] = false; btn.classList.remove('active'); }, {passive: false});
        
        // Hỗ trợ chuột click vào nút ảo (để test trên PC)
        btn.addEventListener('mousedown', (e) => { input[key] = true; btn.classList.add('active'); });
        btn.addEventListener('mouseup', (e) => { input[key] = false; btn.classList.remove('active'); });
        btn.addEventListener('mouseleave', (e) => { input[key] = false; btn.classList.remove('active'); });
    }

    setupTouchButton('btn-left', 'left');
    setupTouchButton('btn-right', 'right');
    setupTouchButton('btn-jump', 'jump');

    // --- GAME LOOP ---
    function update() {
        // Di chuyển ngang
        if (input.right) player.dx = player.speed;
        else if (input.left) player.dx = -player.speed;
        else player.dx = 0;

        // Nhảy
        if (input.jump && player.grounded) {
            player.dy = player.jumpPower;
            player.grounded = false;
        }

        // Vật lý & Va chạm (Giữ nguyên code cũ)
        player.dy += player.gravity;
        player.x += player.dx;
        player.y += player.dy;
        player.grounded = false;

        platforms.forEach(p => {
            if (player.x < p.x + p.w && player.x + player.width > p.x &&
                player.y < p.y + p.h && player.y + player.height > p.y) {
                
                if (player.dy > 0 && player.y + player.height - player.dy <= p.y) {
                    player.grounded = true;
                    player.dy = 0;
                    player.y = p.y - player.height;
                    if (p.type === 2) p.y += 3; // Troll: Sàn rơi
                }
                else if (player.dy < 0 && player.y - player.dy >= p.y + p.h) {
                    player.dy = 0;
                    player.y = p.y + p.h;
                    if (p.type === 1) p.visible = true; // Troll: Hiện khối tàng hình
                }
                else {
                    player.dx = 0;
                    if (player.x < p.x) player.x = p.x - player.width;
                    else player.x = p.x + p.w;
                    if (p.type === 1) p.visible = true;
                }
            }
        });

        // Troll logic: Đích chạy trốn
        if (Math.abs(player.x - goal.x) < 100 && player.y < goal.y + 100) {
            goal.x += 2;
            if(goal.x > 750) goal.x = 750;
            if (Math.abs(player.x - goal.x) < 20) {
                 msgDiv.innerText = "Lêu lêu! Hụt rồi!";
                 goal.x = 50; goal.y = 100;
            }
        }

        // Kiểm tra chết
        if (player.y > canvas.height) {
            msgDiv.innerText = "Gà quá! Lại nhé.";
            msgDiv.style.color = "red";
            setTimeout(initMap, 500);
        }
    }

    function draw() {
        // Auto resize canvas cho vừa màn hình mobile (cơ bản)
        // Lưu ý: Logic game vẫn chạy trên 800x400, chỉ scale hiển thị
        let scale = Math.min(window.innerWidth / 800, window.innerHeight / 500);
        if(isMobile) {
            // Trên mobile thì scale canvas để vừa màn hình
            // canvas.style.width = (800 * scale) + 'px';
            // canvas.style.height = (400 * scale) + 'px';
             // Đơn giản hơn: dùng CSS max-width: 100% đã xử lý
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Vẽ Platforms
        platforms.forEach(p => {
            if (p.type === 0 || p.type === 2) {
                ctx.fillStyle = (p.type === 2) ? '#7f8c8d' : '#333';
                ctx.fillRect(p.x, p.y, p.w, p.h);
            } else if (p.type === 1 && p.visible) {
                ctx.fillStyle = '#fab1a0';
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.strokeRect(p.x, p.y, p.w, p.h);
            }
        });

        // Vẽ Player
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.width, player.height);
        
        // Vẽ mắt
        ctx.fillStyle = 'white';
        ctx.fillRect(player.x + 5, player.y + 5, 8, 8);
        ctx.fillRect(player.x + 18, player.y + 5, 8, 8);
        ctx.fillStyle = 'black';
        ctx.fillRect(player.x + 7, player.y + 7, 4, 4);
        ctx.fillRect(player.x + 20, player.y + 7, 4, 4);

        // Vẽ Đích
        ctx.fillStyle = goal.color;
        ctx.fillRect(goal.x, goal.y, goal.width, goal.height);
        ctx.fillStyle = "#fff";
        ctx.font = "20px Arial";
        ctx.fillText("WIN", goal.x + 2, goal.y + 25);
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    initMap();
    gameLoop();

</script>

</body>
</html>
