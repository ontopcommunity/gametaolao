<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troll Maze - Tomb of the Mask Style</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            background-color: #222;
            font-family: sans-serif;
            height: 100vh;
            margin: 0;
        }
        #game-container {
            position: relative;
        }
        canvas {
            border: 4px solid #555;
            background-color: #111;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        #timer {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #ffcc00;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            color: #ff5555;
            text-shadow: 2px 2px 4px #000;
            display: none; /* Ẩn mặc định */
        }
    </style>
</head>
<body>
    <div id="timer">Thời gian đổi map: 30s</div>
    <div id="game-container">
        <canvas id="mazeCanvas" width="600" height="600"></canvas>
        <div id="message"></div>
    </div>
    <p>Sử dụng các phím mũi tên hoặc WASD để di chuyển.</p>

    <script>
        const canvas = document.getElementById('mazeCanvas');
        const ctx = canvas.getContext('2d');
        const timerElement = document.getElementById('timer');
        const messageElement = document.getElementById('message');

        // Cấu hình game
        const cols = 21; // Số cột (nên là số lẻ cho thuật toán Prim)
        const rows = 21; // Số hàng (nên là số lẻ)
        const cellSize = canvas.width / cols;
        const wallColor = '#444';
        const pathColor = '#111';
        const playerColor = '#00ffcc';
        const goalColor = '#ffcc00';
        const resetTime = 30; // Thời gian reset mê cung (giây)

        let maze = [];
        let player = { x: 1, y: 1 };
        let goal = { x: cols - 2, y: rows - 2 };
        let timeLeft = resetTime;
        let timerInterval;
        let isMoving = false; // Biến kiểm tra xem người chơi có đang trượt không

        // --- HÀM TẠO MÊ CUNG (Thuật toán Prim) ---
        function generateMaze() {
            maze = [];
            for (let r = 0; r < rows; r++) {
                maze[r] = [];
                for (let c = 0; c < cols; c++) {
                    maze[r][c] = 1; // 1 là tường, 0 là đường đi
                }
            }

            let startX = 1;
            let startY = 1;
            maze[startY][startX] = 0;
            
            let walls = [];
            addWalls(startX, startY, walls);

            while (walls.length > 0) {
                let randomIndex = Math.floor(Math.random() * walls.length);
                let wall = walls[randomIndex];
                walls.splice(randomIndex, 1);

                let nextX = wall.x + wall.dx;
                let nextY = wall.y + wall.dy;

                if (nextX > 0 && nextX < cols - 1 && nextY > 0 && nextY < rows - 1 && maze[nextY][nextX] === 1) {
                    maze[wall.y][wall.x] = 0;
                    maze[nextY][nextX] = 0;
                    addWalls(nextX, nextY, walls);
                }
            }
            // Đảm bảo điểm đích luôn là đường đi
            maze[goal.y][goal.x] = 0;
        }

        function addWalls(x, y, walls) {
            const directions = [
                { dx: 1, dy: 0 }, { dx: -1, dy: 0 },
                { dx: 0, dy: 1 }, { dx: 0, dy: -1 }
            ];
            directions.forEach(dir => {
                walls.push({ x: x + dir.dx, y: y + dir.dy, dx: dir.dx, dy: dir.dy });
            });
        }

        // --- HÀM VẼ ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    ctx.fillStyle = maze[r][c] === 1 ? wallColor : pathColor;
                    ctx.fillRect(c * cellSize, r * cellSize, cellSize, cellSize);
                }
            }
            // Vẽ đích
            ctx.fillStyle = goalColor;
            ctx.fillRect(goal.x * cellSize + cellSize / 4, goal.y * cellSize + cellSize / 4, cellSize / 2, cellSize / 2);
            // Vẽ người chơi
            ctx.fillStyle = playerColor;
            ctx.beginPath();
            ctx.arc(player.x * cellSize + cellSize / 2, player.y * cellSize + cellSize / 2, cellSize / 3, 0, Math.PI * 2);
            ctx.fill();
        }

        // --- HÀM DI CHUYỂN (Kiểu Tomb of the Mask) ---
        function move(dx, dy) {
            if (isMoving) return; // Không nhận lệnh mới khi đang di chuyển

            isMoving = true;
            let nextX = player.x + dx;
            let nextY = player.y + dy;

            const slideInterval = setInterval(() => {
                // Kiểm tra nếu chạm tường
                if (maze[nextY][nextX] === 1) {
                    clearInterval(slideInterval);
                    isMoving = false;
                    checkWin();
                    draw(); // Vẽ lại lần cuối để khớp vị trí
                    return;
                }

                // Cập nhật vị trí
                player.x = nextX;
                player.y = nextY;
                draw(); // Vẽ lại sau mỗi bước di chuyển để tạo hiệu ứng trượt

                // Kiểm tra chiến thắng trong lúc trượt
                if (player.x === goal.x && player.y === goal.y) {
                    clearInterval(slideInterval);
                    isMoving = false;
                    checkWin();
                    return;
                }

                // Tính toán vị trí tiếp theo
                nextX += dx;
                nextY += dy;
            }, 30); // Tốc độ trượt (càng nhỏ càng nhanh)
        }

        // --- XỬ LÝ SỰ KIỆN PHÍM ---
        document.addEventListener('keydown', (e) => {
            if (['ArrowUp', 'KeyW'].includes(e.code)) move(0, -1);
            else if (['ArrowDown', 'KeyS'].includes(e.code)) move(0, 1);
            else if (['ArrowLeft', 'KeyA'].includes(e.code)) move(-1, 0);
            else if (['ArrowRight', 'KeyD'].includes(e.code)) move(1, 0);
        });

        // --- HÀM KIỂM TRA CHIẾN THẮNG ---
        function checkWin() {
            if (player.x === goal.x && player.y === goal.y) {
                showMessage("BẠN THẮNG!... nhưng mê cung vẫn đổi :))");
                setTimeout(resetGame, 2000);
            }
        }

        // --- HÀM HIỆN THÔNG BÁO ---
        function showMessage(text) {
            messageElement.innerText = text;
            messageElement.style.display = 'block';
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 1500);
        }

        // --- HÀM RESET GAME & TIMER ---
        function resetGame() {
            generateMaze();
            player = { x: 1, y: 1 }; // Đặt lại vị trí người chơi về điểm bắt đầu
            draw();
            timeLeft = resetTime;
            timerElement.innerText = `Thời gian đổi map: ${timeLeft}s`;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                timerElement.innerText = `Thời gian đổi map: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    showMessage("HẾT GIỜ! Mê cung đã thay đổi! Haha!");
                    resetGame();
                }
            }, 1000);
        }

        // --- KHỞI CHẠY GAME ---
        resetGame();
        startTimer();

    </script>
</body>
</html>
