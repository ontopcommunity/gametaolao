<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maze Game - High D-Pad</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh; /* Full màn hình */
            color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* --- UI LAYER --- */
        #top-ui {
            width: 100%;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            background: rgba(0,0,0,0.3);
            flex-shrink: 0; /* Không bị co lại */
        }

        #timer {
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f;
        }

        #status {
            font-size: 14px;
            color: #ecf0f1;
        }

        /* --- GAME WRAPPER --- */
        /* Đây là khu vực chứa mê cung */
        #game-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Căn lên trên để chừa chỗ dưới cho nút */
            overflow: hidden;
            padding-top: 10px;
            flex-grow: 1;
        }

        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 2px solid #7f8c8d;
            border-radius: 4px;
            background: #000;
        }

        /* --- D-PAD CONTROLS (MOBILE) --- */
        #controls-area {
            position: fixed; /* Cố định vị trí */
            bottom: 50px;    /* Nâng lên cao cách đáy 50px */
            left: 0;
            width: 100%;
            height: 200px;   /* Chiều cao khu vực nút bấm */
            display: none;   /* Ẩn trên PC */
            justify-content: center;
            align-items: center;
            z-index: 100;    /* Nổi lên trên cùng */
            pointer-events: none; /* Để bấm xuyên qua vùng trống */
        }

        .dpad {
            display: grid;
            grid-template-columns: 75px 75px 75px;
            grid-template-rows: 75px 75px;
            gap: 10px; /* Khoảng cách giữa các nút rộng ra */
            pointer-events: auto; /* Kích hoạt lại cảm ứng cho nút */
            background: rgba(0,0,0,0.3); /* Nền mờ bao quanh cụm nút cho dễ nhìn */
            padding: 15px;
            border-radius: 20px;
        }

        .btn {
            width: 75px;
            height: 75px;
            background: rgba(255, 255, 255, 0.2); /* Màu sáng hơn */
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            user-select: none;
            cursor: pointer;
            color: white;
            transition: transform 0.1s, background 0.1s;
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active, .btn.active {
            background: rgba(231, 76, 60, 0.8); /* Màu đỏ rõ khi bấm */
            transform: scale(0.90);
        }

        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }

        /* --- MESSAGE OVERLAY --- */
        #msg-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.85);
            font-size: 22px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            display: none;
            z-index: 200;
            font-weight: bold;
            color: #e74c3c;
        }
    </style>
</head>
<body>

    <div id="top-ui">
        <div id="status">Map 31x31</div>
        <div id="timer">45s</div>
    </div>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>
    </div>
    
    <div id="msg-overlay"></div>

    <div id="controls-area">
        <div class="dpad">
            <div class="btn" id="btn-up">▲</div>
            <div class="btn" id="btn-left">◄</div>
            <div class="btn" id="btn-down">▼</div>
            <div class="btn" id="btn-right">►</div>
        </div>
    </div>

<script>
    // --- CẤU HÌNH ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const timerDisplay = document.getElementById('timer');
    const msgOverlay = document.getElementById('msg-overlay');
    const controlsArea = document.getElementById('controls-area');

    const COLS = 31; 
    const ROWS = 31; 
    let TILE_SIZE = 0; 
    let MAX_TIME = 45; 
    const MOVE_SPEED_MS = 80; // Tốc độ di chuyển

    const COLORS = {
        wall: '#34495e',
        path: '#ecf0f1',
        player: '#e67e22', 
        goal: '#2ecc71'    
    };

    let maze = [];
    let player = { x: 1, y: 1 };
    let goal = { x: 1, y: 1 };
    
    let currentDir = { x: 0, y: 0 };
    let lastMoveTime = 0;
    
    let timeLeft = MAX_TIME;
    let timerInterval = null;

    // --- PHÁT HIỆN THIẾT BỊ ---
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        controlsArea.style.display = 'flex'; 
        document.getElementById('status').innerText = "Giữ nút để chạy";
    } else {
        document.getElementById('status').innerText = "Giữ phím WASD / Mũi tên";
    }

    // --- RESPONSIVE CANVAS ---
    function resize() {
        let availableWidth = window.innerWidth;
        
        // Tính toán chiều cao khả dụng
        // Nếu là mobile, ta trừ đi phần không gian dành cho nút bấm (khoảng 260px từ dưới lên)
        // Để đảm bảo mê cung nằm phía trên các nút
        let uiHeight = 50; // Top bar
        let controlHeight = isMobile ? 260 : 0; 
        
        let availableHeight = window.innerHeight - uiHeight - controlHeight;

        // Tính kích thước ô vuông
        let size = Math.min(availableWidth, availableHeight) * 0.96; 
        
        TILE_SIZE = Math.floor(size / COLS);
        
        canvas.width = TILE_SIZE * COLS;
        canvas.height = TILE_SIZE * ROWS;
        draw();
    }
    // Gọi resize ngay lập tức và khi xoay màn hình
    window.addEventListener('resize', resize);
    window.addEventListener('orientationchange', () => { setTimeout(resize, 200); });

    // --- TẠO MÊ CUNG ---
    function generateMaze() {
        maze = [];
        for(let y=0; y<ROWS; y++) {
            let row = [];
            for(let x=0; x<COLS; x++) { row.push(1); }
            maze.push(row);
        }

        let walls = [];
        maze[1][1] = 0;
        addWalls(1, 1, walls);

        while(walls.length > 0) {
            let idx = Math.floor(Math.random() * walls.length);
            let w = walls[idx];
            walls.splice(idx, 1);

            let nx = w.x + w.dx;
            let ny = w.y + w.dy;

            if(nx > 0 && nx < COLS-1 && ny > 0 && ny < ROWS-1 && maze[ny][nx] === 1) {
                maze[w.y][w.x] = 0; 
                maze[ny][nx] = 0;   
                addWalls(nx, ny, walls);
            }
        }
        
        player = { x: 1, y: 1 };
        goal = { x: COLS - 2, y: ROWS - 2 };
        maze[goal.y][goal.x] = 0; 
    }

    function addWalls(x, y, walls) {
        if(x+2 < COLS) walls.push({x: x+1, y: y, dx: 1, dy: 0});
        if(x-2 > 0)    walls.push({x: x-1, y: y, dx: -1, dy: 0});
        if(y+2 < ROWS) walls.push({x: x, y: y+1, dx: 0, dy: 1});
        if(y-2 > 0)    walls.push({x: x, y: y-1, dx: 0, dy: -1});
    }

    // --- GAME LOOP ---
    function gameLoop() {
        const now = Date.now();
        if ((currentDir.x !== 0 || currentDir.y !== 0) && (now - lastMoveTime > MOVE_SPEED_MS)) {
            let nextX = player.x + currentDir.x;
            let nextY = player.y + currentDir.y;

            if (maze[nextY][nextX] === 0) {
                player.x = nextX;
                player.y = nextY;
                lastMoveTime = now;
                if (player.x === goal.x && player.y === goal.y) checkWin();
            }
            draw();
        }
        requestAnimationFrame(gameLoop);
    }

    // --- INPUT ---
    const activeKeys = new Set();

    document.addEventListener('keydown', (e) => {
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','KeyW','KeyA','KeyS','KeyD'].includes(e.code)) {
            e.preventDefault();
            activeKeys.add(e.code);
            updateDirection();
        }
    });

    document.addEventListener('keyup', (e) => {
        if(activeKeys.has(e.code)) {
            activeKeys.delete(e.code);
            updateDirection();
        }
    });

    function updateDirection() {
        currentDir = { x: 0, y: 0 };
        if (activeKeys.has('ArrowUp') || activeKeys.has('KeyW')) { currentDir = { x: 0, y: -1 }; return; }
        if (activeKeys.has('ArrowDown') || activeKeys.has('KeyS')) { currentDir = { x: 0, y: 1 }; return; }
        if (activeKeys.has('ArrowLeft') || activeKeys.has('KeyA')) { currentDir = { x: -1, y: 0 }; return; }
        if (activeKeys.has('ArrowRight') || activeKeys.has('KeyD')) { currentDir = { x: 1, y: 0 }; return; }
    }

    function setupTouchBtn(id, dx, dy) {
        const btn = document.getElementById(id);
        const startMove = (e) => {
            e.preventDefault();
            currentDir = { x: dx, y: dy };
            btn.classList.add('active');
        };
        const stopMove = (e) => {
            e.preventDefault();
            if (currentDir.x === dx && currentDir.y === dy) currentDir = { x: 0, y: 0 };
            btn.classList.remove('active');
        };
        btn.addEventListener('touchstart', startMove, {passive: false});
        btn.addEventListener('touchend', stopMove, {passive: false});
        btn.addEventListener('mousedown', startMove);
        btn.addEventListener('mouseup', stopMove);
        btn.addEventListener('mouseleave', stopMove);
    }

    setupTouchBtn('btn-up', 0, -1);
    setupTouchBtn('btn-down', 0, 1);
    setupTouchBtn('btn-left', -1, 0);
    setupTouchBtn('btn-right', 1, 0);

    // --- DRAW ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        for(let y=0; y<ROWS; y++) {
            for(let x=0; x<COLS; x++) {
                if(maze[y][x] === 1) {
                    ctx.fillStyle = COLORS.wall;
                    ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                } else {
                    ctx.fillStyle = COLORS.path;
                    ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
        }
        ctx.fillStyle = COLORS.goal;
        let p = TILE_SIZE * 0.15;
        ctx.fillRect(goal.x*TILE_SIZE+p, goal.y*TILE_SIZE+p, TILE_SIZE-2*p, TILE_SIZE-2*p);

        let px = player.x * TILE_SIZE;
        let py = player.y * TILE_SIZE;
        ctx.fillStyle = COLORS.player;
        ctx.beginPath();
        ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, TILE_SIZE/2.5, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.beginPath();
        ctx.arc(px + TILE_SIZE/2 - 3, py + TILE_SIZE/2 - 2, 2, 0, Math.PI*2);
        ctx.arc(px + TILE_SIZE/2 + 3, py + TILE_SIZE/2 - 2, 2, 0, Math.PI*2);
        ctx.fill();
    }

    // --- LOGIC ---
    function checkWin() {
        currentDir = { x: 0, y: 0 }; 
        showMsg("THẮNG RỒI!<br>Reset sau 2s");
        setTimeout(resetGame, 2000);
    }

    function showMsg(html) {
        msgOverlay.innerHTML = html;
        msgOverlay.style.display = 'flex';
        setTimeout(() => { msgOverlay.style.display = 'none'; }, 1500);
    }

    function resetGame() {
        currentDir = { x: 0, y: 0 };
        activeKeys.clear();
        generateMaze();
        resize();
        timeLeft = MAX_TIME;
        updateTimer();
    }

    function updateTimer() {
        timerDisplay.innerText = timeLeft + "s";
        timerDisplay.style.color = timeLeft <= 10 ? "#e74c3c" : "#f1c40f";
    }

    function startTimerLoop() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimer();
            if(timeLeft <= 0) {
                showMsg("HẾT GIỜ!<br>Đổi map khác!");
                resetGame();
            }
        }, 1000);
    }

    resetGame();
    startTimerLoop();
    requestAnimationFrame(gameLoop);

</script>
</body>
</html>
